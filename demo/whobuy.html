<html>
<head>
  <title></title>
  <link href="http://f2e.souche.com/assets/css/index/index_11.css" rel="stylesheet" type="text/css" />
  <link href="http://f2e.souche.com/assets/css/souche/$$reset.css,ui.css" rel="stylesheet" type="text/css" />
</head>
<body>
 <script>
     var audioCtx = new (window.AudioContext || window.webkitAudioContext)(); // define audio context
     // Webkit/blink browsers need prefix, Safari won't work without window.

     var voiceSelect = document.getElementById("voice"); // select box for selecting voice effect options
     var visualSelect = document.getElementById("visual"); // select box for selecting audio visualization options
     var mute = document.querySelector('.mute'); // mute button
     var drawVisual; // requestAnimationFrame

     var analyser = audioCtx.createAnalyser();
     var distortion = audioCtx.createWaveShaper();
     var gainNode = audioCtx.createGain();
     var biquadFilter = audioCtx.createBiquadFilter();

     navigator.getMedia = ( navigator.getUserMedia ||
             navigator.webkitGetUserMedia ||
             navigator.mozGetUserMedia ||
             navigator.msGetUserMedia);
     var streamon = function(stream) {
         source = audioCtx.createMediaStreamSource(stream);
         source.connect(analyser);
         analyser.connect(distortion);
         distortion.connect(biquadFilter);
         biquadFilter.connect(gainNode);
         gainNode.connect(audioCtx.destination); // connecting the different audio graph nodes together

         visualize(stream);
         voiceChange();

     }
     function visualize(stream) {
         WIDTH = canvas.width;
         HEIGHT = canvas.height;

         var visualSetting = visualSelect.value;
         console.log(visualSetting);

         if(visualSetting == "sinewave") {
             analyser.fftSize = 2048;
             var bufferLength = analyser.frequencyBinCount; // half the FFT value
             var dataArray = new Uint8Array(bufferLength); // create an array to store the data

             canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

             function draw() {

                 drawVisual = requestAnimationFrame(draw);

                 analyser.getByteTimeDomainData(dataArray); // get waveform data and put it into the array created above

                 canvasCtx.fillStyle = 'rgb(200, 200, 200)'; // draw wave with canvas
                 canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

                 canvasCtx.lineWidth = 2;
                 canvasCtx.strokeStyle = 'rgb(0, 0, 0)';

                 canvasCtx.beginPath();

                 var sliceWidth = WIDTH * 1.0 / bufferLength;
                 var x = 0;

                 for(var i = 0; i < bufferLength; i++) {

                     var v = dataArray[i] / 128.0;
                     var y = v * HEIGHT/2;

                     if(i === 0) {
                         canvasCtx.moveTo(x, y);
                     } else {
                         canvasCtx.lineTo(x, y);
                     }

                     x += sliceWidth;
                 }

                 canvasCtx.lineTo(canvas.width, canvas.height/2);
                 canvasCtx.stroke();
             };

             draw();

         } else if(visualSetting == "off") {
             canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
             canvasCtx.fillStyle = "red";
             canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
         }

     }
     navigator.getMedia (

             // constraints
             {
                 video: true,
                 audio: true
             },

             // successCallback
             function(localMediaStream) {
                 var video = document.querySelector('video');
                 video.src = window.URL.createObjectURL(localMediaStream);
                 video.onloadedmetadata = function(e) {
                     // Do something with the video here.
                 };
             },

             // errorCallback
             function(err) {
                 console.log("The following error occured: " + err);
             }

     );
 </script>
</body>
</html>
