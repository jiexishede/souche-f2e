define(["lib/mustache","souche/range-slide"],function(e,n){var t=function(){function t(e){var n=e,t={brands:{},toggleSeries:function(e,t,i){var a=this.brands,r=a[e];if(r&&r[t])this.removeSeries(e,t),$.isEmptyObject(a)&&n.hide();else{if($.isEmptyObject(a)&&n.show(),r=a[e]=a[e]||{},""==t)for(var s in r)this.removeSeries(e,s);else this.removeSeries(e,"");this.addSeries(e,t,i)}},removeSeries:function(e,n){var t=this.brands[e];if(n in t){var i=t[n];i[0].remove(),i[1].removeClass("selected"),delete t[n],$.isEmptyObject(t)&&delete this.brands[e]}},addSeries:function(e,t,i){var a=this.brands,r=a[e]=a[e]||{};r[t]=i,n.append(i[0]),i[1].addClass("selected")}};return t}return{init:function(){function i(e){h.push(l),e=e||l+1,document.body.scrollTop=0,3==e?$("#submit-btn").text("完成定制").show():4==e?$("#submit-btn").hide():$("#submit-btn").text("下一步").show();var n=u[l-1],t=u[e-1];t.css({left:"100%"}).show(),n.animate({left:"-100%"},function(){n.hide()}),t.animate({left:"0"}),l=e}function a(){document.body.scrollTop=0;var e=h.pop();if(0==e)return void(-1!=document.referrer.indexOf("souche")?history.back():window.location.href="index.html");3==e?$(".next-btn").text("完成定制").show():4==e?$(".next-btn").hide():$(".next-btn").text("下一步").show();var n=u[l-1],t=u[e-1];t.css({left:"-100%"}).show(),n.animate({left:"100%"},function(){n.hide()}),t.animate({left:"0"}),l=e}function r(){p.removeClass("hidden"),BrandAjaxUtil.getRecomBrands(function(n){for(var t=n.brands,i=$("#brand-icons-container"),a='<div class="icon-group">',r="</div>",s="",o=0;o<t.length;o++)s+=e.render(f,{brand:t[4*o+j]}),i.append(a+s+r),s=""})}function s(){var e=c.getData(),n=d.brands,t=e.min.value.replace("万",""),a=e.max.value.replace("万","");"无限"==a&&(a=1e4);var r="",s="";for(var o in n)for(var l in n[o])""==l?r+=","+o:s+=","+l;r=r.substring(1),s=s.substring(1),i(),$.ajax({url:contextPath+"/mobile/carCustomAction/saveBuyInfo.json",dataType:"json",data:{brands:r,series:s,year:g,minPrice:t,maxPrice:a},success:function(){window.location.href=contextPath+"/mobile/carcustom.html"},error:function(){alert("error")}})}function o(){$(".cover-layer").removeClass("hidden");var e=$(window).width(),n=(e-300)/2;$("#phone-popup").css({left:n}).removeClass("hidden")}var c=new n({ele:".sc-rangeslider",steps:["0万","3万","5万","6万","7万","8万","9万","10万","12万","14万","15万","16万","18万","20万","22万","24万","25万","30万","35万","40万","50万","60万","70万","100万","无限"],min:"8万",max:"20万",tpl:"%"}),d=t($(".selected-brand")),d=t($(".selected-brand")),l=1,h=[];h.push(0);var u=[$("#page-1"),$("#page-2"),$("#page-3"),$("#page-4")],v=!1;$(".next-btn").on("click",function(){v&&1==l?r():i()});var f=$("#tpl_brand").text(),b=($("#tpl_series").text(),11);$("#page-2 .next-btn").click(function(){i()}),$(".back-icon").click(function(){a()}),$(".selected-brand").on("click",".sb-item",function(){var e=$(this),n=e.attr("brand-code"),t=e.attr("series-code");d.toggleSeries(n,t)});var m,p=$(".loading-cover-layer");$("#brand-icons-container").on("click",".icon-item",function(){var e=$(this),n=e.attr("data-code"),t=e.find(".brand-name").text(),i='<div class="sb-item" brand-code='+n+' series-code=><span class="text">'+t+'</span><i class="close-icon"></i></div>';d.toggleSeries(n,"",[$(i),$("body")])}),$("#brand-icons-container").one("click","#more-brand",function(){var n,t='<div class="icon-group">',i="</div>",a="",r=allBrands,s=r.length;console.log(s);var o=e.render(f,{brand:r[b]}),c=$(this).closest(".icon-group");$(this).parent(".icon-item-more").remove(),c.append(o);for(var d=Math.ceil(s/4),l=Math.ceil((b+1)/4),h=l;d>h;h++){n=Math.min(s-4*h,4);for(var u=0;n>u;u++)a+=e.render(f,{brand:r[4*h+u]});$("#brand-icons-container").append(t+a+i),a=""}}),$("#brand-icons-container").on("click",".series-item",function(){var e=$(this),n=(e.attr("data-index"),e.attr("data-code")),t=e.find(".text");if("__more__"==n)return e.siblings(".series-item").show(),void e.remove();var i;i=t.attr("data-brand-name")?t.attr("data-brand-name"):t.text();var a='<div class="sb-item" brand-code='+m+" series-code="+n+'><span class="text">'+i+'</span><i class="close-icon"></i></div>';d.toggleSeries(m,n,[$(a),t])});var g="";$(".year-item").click(function(){$(".year-item .text").removeClass("selected"),$(this).find(".text").addClass("selected"),g=$(this).attr("data-code")}),$("#submit-btn").click(function(){return 3!=l?void i():void SM.checkPhoneExist(function(e){e?s():o()})});var x=/^1[3458][0-9]{9}$/;$("#phone-form").submit(function(e){var n=$("#phone-num").val();e.preventDefault(),x.test(n)?SM.PhoneRegister(n,function(){s()}):alert("请输入正确的手机号码")}),$(".search-icon").click(function(){var e=$(this).siblings(".search-icon-2");$(this).parent().siblings(".search-box").show(),$(this).hide(),e.show()}),$(".search-icon-2").click(function(){var e=$(this).siblings(".search-icon");$(this).parent().siblings(".search-box").hide(),$(this).hide(),e.show()}),$(".cancel-icon").click(function(){var e=$(this).siblings("input[name=keyword]");e.val(""),e.focus()}),$(".search-form").submit(function(e){var n=$(this).find("input[name=keyword]");""==n.val().trim()&&(n.val(""),e.preventDefault())}),$(".search-btn").click(function(){var e=$(this).siblings(".input").find("input[name=keyword]");""==e.val().trim()?e.val(""):e.parent().submit()});var w=1;$ellipsis=$("#page-4 .ellipsis"),setInterval(function(){for(var e="",n=0;w>n;n++)e+=".";$ellipsis.text(e),3==w?w=1:w++},500)}}}();return t});