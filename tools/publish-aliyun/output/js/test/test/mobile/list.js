var List=function(){var e,t={page:1,moreURL:""},n=function(){SM.LoadingTip.show("正在加载中"),$.ajax({url:t.moreURL+"&index="+ ++t.page,dataType:"json",success:function(n){console.log(n);var a=Mustache.render(e,{cars:n.page?n.page.items:[],yushouCars:n.yushouPage?n.yushouPage.items:[]});$(".cars").append(a),n.totalPage==t.page&&$("#load_more").addClass("hidden"),SM.LoadingTip.hide()},error:function(){SM.LoadingTip.hide()}})};return{init:function(n){for(var a in n)t[a]=n[a];e=$("#tpl_cars").html(),this.bind()},bind:function(){$("#filter").css("left",-$(window).width()),$("#list .filter .t").on("click",function(){setTimeout(function(){$("#content").css("height",0)},400),$("#filter").animate({left:0},300),$("html,body").scrollTop(0),window.history.pushState({time:(new Date).getTime()},"",window.location.href.replace(/#filter/g,"")+"#filter"),$("#xuan").addClass("hidden")}),$("#xuan").on("click",function(e){e.preventDefault(),setTimeout(function(){$("#content").css("height",0)},400),$("#filter").animate({left:0},300),$("html,body").scrollTop(0),window.history.pushState({time:(new Date).getTime()},"",window.location.href.replace(/#filter/g,"")+"#filter"),$("#xuan").addClass("hidden")}),$("#filter .back").on("click",function(){$("#filter").animate({left:-$(window).width()},300),$("#content").css("height","auto"),$("#xuan").removeClass("hidden")}),$("#load_more").on("click",function(e){e.preventDefault(),n()}),window.onpopstate=function(){"#filter"!=window.location.hash&&($("#filter").animate({left:-$(window).width()},300),$("#content").css("height","auto"),$("#xuan").removeClass("hidden"))},"#filter"==window.location.hash&&(setTimeout(function(){$("#content").css("height",0)},400),$("html,body").scrollTop(0),$("#filter").css({left:0}),$("#xuan").addClass("hidden"))}}}(),Filter=function(){var e={carBrand:null,carSeries:null,carPrice:null,carModel:null,carMileage:null,carYear:null,carTime:null,saleType:null},t={sellType:null,isFenqi:null},n={sortName:"",sortType:"",baseURL:""},a=function(){var t="";for(var n in e)e[n]?($("#"+n).parent().find(".value").html(e[n].name),t+='<a class="item" data-id="'+n+'">'+e[n].name+'<s class="close" href=""><span></span></s></a>'):$("#"+n).parent().find(".value").html("");$("#filter_list").html(t)},i=function(){e={carBrand:null,carSeries:null,carPrice:null,carModel:null,carMileage:null,carYear:null,carTime:null,saleType:null},a()},r="filter_history",l=[],o=function(e,t){var n=!0;for(var a in e)try{e[a]!=t[a]&&(null==e[a]?n=!1:null==t[a]?n=!1:e[a].code!=t[a].code&&(n=!1))}catch(i){alert(i)}return n},s=function(){l=l.splice(0,5),0!=l.length&&$("#history_group").html(""),l.forEach(function(t){var i=[];for(var r in t.filters)t.filters[r]&&i.push(t.filters[r].name);var l=$("<div class=option data-attr='"+JSON.stringify(t)+"''><div class=name >"+i.join("+")+"</div><i></i></div>");l.on("click",function(){var t=JSON.parse($(this).attr("data-attr"));e=t.filters,a(),window.location.href=n.baseURL+function(){var t=[];for(var n in e)t.push(e[n]?n+"="+e[n].code:n+"=");return t.join("&")}()}),$("#history_group").append(l)})},c=function(e){$("#carSeries").html("<option>选项正在加载中，请稍候</option>"),$.ajax({url:n.seriesURL,type:"post",data:{request_message:'{"code":"'+e+'","type":"car-subdivision"}'},dataType:"json",success:function(e){$("#carSeries").html("<option>-请选择-</option>");for(var t in e.codes){var n=$('<optgroup label="'+t+'"/>');e.codes[t].forEach(function(e){n.append("<option value="+e.code+">"+e.name+"</option>")}),$("#carSeries").append(n)}}})};return{init:function(t){for(var i in t)n[i]=t[i];this.bind();try{if(l=JSON.parse(localStorage.getItem(r)),!l||!l.length)throw new Error("error")}catch(o){l=[]}s(),e={carBrand:null,carSeries:null,carPrice:null,carModel:null,carMileage:null,carYear:null,carTime:null,saleType:null};for(var i in e)t.defaultParams[i]&&t.defaultParams[i].name&&(e[i]=t.defaultParams[i],"carBrand"==i&&c(e[i].code));a()},bind:function(){Souche.UI.Select.init({eles:["carBrand","carSeries"],type:"car-subdivision",defaultValues:[]});for(var s in e)$("#"+s).on("change",function(){e[this.id]=""!==this.value?{code:this.value,name:this.options[this.selectedIndex].innerHTML}:null,"carBrand"==this.id&&(e.carSeries=null,c(this.value)),a()});$("#filter_list").on("click",function(t){if(t.preventDefault(),$(t.target).hasClass("item")||$(t.target).hasClass("close")){var n=$(t.target).attr("data-id")||$(t.target.parentNode).attr("data-id");e[n]=null,"carBrand"==n&&(e.carBrand=null,e.carSeries=null,$("#carSeries").html("")),$("#"+$(t.target).attr("data-id")).find("option").attr("selected",!1)}a()}),$("#reset_filters").on("click",function(){i()}),$("#submit_filters,#submit_filters2").on("click",function(){for(var a=0;a<l.length;a++)o(l[a].filters,e)&&l.splice(a,1);l.unshift({filters:e,options:t}),l=l.splice(0,5);try{localStorage.setItem(r,JSON.stringify(l))}catch(i){}window.location.href=n.baseURL+function(){var t=[];for(var n in e)t.push(e[n]?n+"="+e[n].code:n+"=");return t.join("&")}()}),$("#history").on("change",function(){var t=JSON.parse(this.value);console.log(t.filters),e=t.filters,a()})}}}();