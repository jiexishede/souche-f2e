function OssClient(e){this._accessId=e.accessId,this._accessKey=e.accessKey,this._host="oss.aliyuncs.com",this._port="8080",this._timeout=3e6}function debug(e){debugLevel>0&&console.log(e)}var fs=require("fs"),path=require("path"),util=require("util"),crypto=require("crypto"),xml2js=require("xml2js"),request=require("request"),mimetypes=require("./mimetypes");OssClient.prototype.getSign=function(e,t,r,s,o,n){var i=[e,t||"",r||"",s];if(o)for(var u=Object.keys(o).sort(),a=0,c=u.length;c>a;a++){var p=u[a];i.push(p.toLowerCase()+":"+o[p])}i.push(n),debug(i);var l=crypto.createHmac("sha1",this._accessKey);return l.update(i.join("\n")),"OSS "+this._accessId+":"+l.digest("base64")},OssClient.prototype.getResource=function(e){var t="";return"string"==typeof e.bucket&&(t="/"+e.bucket),"string"==typeof e.object&&(t=t+"/"+e.object),"boolean"==typeof e.isAcl&&(t+="?acl"),"boolean"==typeof e.isGroup&&(t+="?group"),t},OssClient.prototype.getUrl=function(e){var t="http://"+this._host+":"+this._port,r=[];return"string"==typeof e.bucket&&(t=t+"/"+e.bucket),"string"==typeof e.object&&(t=t+"/"+e.object),"string"==typeof e.prefix&&r.push("prefix="+e.prefix),"string"==typeof e.marker&&r.push("marker="+e.marker),"string"==typeof e.maxKeys&&r.push("max-keys="+e.maxKeys),"string"==typeof e.delimiter&&r.push("delimiter="+e.delimiter),r.length>0&&(t=t+"?"+r.join("&")),"boolean"==typeof e.isAcl&&(t+="?acl"),"boolean"==typeof e.isGroup&&(t+="?group"),t},OssClient.prototype.getHeaders=function(e,t,r){var s=(new Date).toGMTString(),o={Date:s};if(r.srcFile){o["content-type"]=mimetypes.lookup(path.extname(r.srcFile)),o["content-Length"]=fs.statSync(r.srcFile).size;var n=crypto.createHash("md5");n.update(fs.readFileSync(r.srcFile)),o["content-Md5"]=n.digest("hex")}if(r.isGroup&&(o["content-type"]="txt/xml"),r.userMetas){t=t||{};for(i in r.userMetas)t[i]=r.userMetas[i]}for(var i in t)o[i]=t[i];for(var i in r.userHeaders)o[i]=r.userHeaders[i];var u=this.getResource(r);return o.Authorization=this.getSign(e,o["content-Md5"],o["content-type"],s,t,u),o},OssClient.prototype.doRequest=function(e,t,r,s){var o={};o.method=e,o.url=this.getUrl(r),o.headers=this.getHeaders(e,t,r),o.timeout=this._timeout,debug(r),debug(o),r.isGroup&&(o.body=this.getObjectGroupPostBody(r.bucket,r.objectArray));var n=request(o,function(t,o,n){if(t&&s)return s(t);if(200!=o.statusCode&&204!=o.statusCode){var i=new Error(n);i.code=o.statusCode,s&&s(i)}else if(n&&!r.dstFile){var u=new xml2js.Parser;u.parseString(n,function(e,t){s(e,t)})}else"HEAD"==e&&s(t,o.headers)});if(r.srcFile){var i=fs.createReadStream(r.srcFile);i.pipe(n)}if(r.dstFile){var u=fs.createWriteStream(r.dstFile);n.pipe(u)}},OssClient.prototype.createBucket=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="PUT",o={"X-OSS-ACL":t},n={bucket:e};this.doRequest(s,o,n,r)},OssClient.prototype.listBucket=function(e){var t="GET",r={bucket:""};this.doRequest(t,null,r,e)},OssClient.prototype.deleteBucket=function(e,t){if(!e)throw new Error("error arguments!");var r="DELETE",s={bucket:e};this.doRequest(r,null,s,t)},OssClient.prototype.getBucketAcl=function(e,t){if(!e)throw new Error("error arguments!");var r="GET",s={bucket:e,isAcl:!0};this.doRequest(r,null,s,t)},OssClient.prototype.setBucketAcl=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="PUT",o={"X-OSS-ACL":t},n={bucket:e};this.doRequest(s,o,n,r)},OssClient.prototype.putObject=function(e,t,r){if(!e||!t||!r)throw new Error("error arguments!");var s=this;args=arguments,fs.stat(r,function(o){if(o)return u(o);var n="PUT",i={bucket:e,object:t,srcFile:r};"object"==typeof arguments[3]&&(i.userMetas=arguments[3]);var u=args[args.length-1];s.doRequest(n,null,i,u)})},OssClient.prototype.copyObject=function(e,t,r,s){if(!e||!t||!r)throw new Error("error arguments!");var o="PUT",n={bucket:e,object:t},i={"x-oss-copy-source":"/"+e+"/"+r};this.doRequest(o,i,n,s)},OssClient.prototype.deleteObject=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="DELETE",o={bucket:e,object:t};this.doRequest(s,null,o,r)},OssClient.prototype.getObject=function(e,t,r,s){if(!e||!t||!r)throw new Error("error arguments!");var o="GET",n={bucket:e,object:t,dstFile:r};"object"==typeof arguments[3]&&(n.userHeaders=arguments[3]);var s=arguments[arguments.length-1];this.doRequest(o,null,n,s)},OssClient.prototype.headObject=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="HEAD",o={bucket:e,object:t};this.doRequest(s,null,o,r)},OssClient.prototype.listObject=function(e,t){if(!e)throw new Error("error arguments!");var r="GET",s={bucket:e};s.prefix=arguments[1]?arguments[1]:null,s.marker=arguments[2]?arguments[2]:null,s.delimiter=arguments[3]?arguments[3]:null,s.maxKeys=arguments[4]?arguments[4]:null;var t=arguments[arguments.length-1];this.doRequest(r,null,s,t)},OssClient.prototype.getObjectEtag=function(e){var t=crypto.createHash("md5");return t.update(fs.readFileSync(e)),t.digest("hex").toUpperCase()},OssClient.prototype.getObjectGroupPostBody=function(e,t){var r="<CreateFileGroup>",s=0;for(i in t){s++;var o=this.getObjectEtag(t[i]);r+="<Part>",r+="<PartNumber>"+s+"</PartNumber>",r+="<PartName>"+t[i]+"</PartName>",r+="<ETag>"+o+"</ETag>",r+="</Part>"}return r+="</CreateFileGroup>"},OssClient.prototype.createObjectGroup=function(e,t,r,s){if(!e||!t||!r)throw new Error("error arguments!");var o="POST",n={bucket:e,object:t,objectArray:r,isGroup:!0};this.doRequest(o,null,n,s)},OssClient.prototype.getObjectGroup=function(e,t,r,s){if(!e||!t||!r)throw new Error("error arguments!");var o="GET",n={bucket:e,object:t,isGroup:!0,dstFile:r};this.doRequest(o,null,n,s)},OssClient.prototype.getObjectGroupIndex=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="GET",o={bucket:e,object:t},n={"X-OSS-FILE-GROUP":""};this.doRequest(s,n,o,r)},OssClient.prototype.headObjectGroup=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="HEAD",o={bucket:e,object:t};this.doRequest(s,null,o,r)},OssClient.prototype.deleteObjectGroup=function(e,t,r){if(!e||!t)throw new Error("error arguments!");var s="DELETE",o={bucket:e,object:t};this.doRequest(s,null,o,r)};var debugLevel=process.env.NODE_DEBUG_OSSCLIENT?1:0;exports.OssClient=OssClient;